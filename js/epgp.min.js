/* EPGP - script to parse & display standings data from the epgp.lua created
 * by the World of Warcraft EPGP addon (http://code.google.com/p/epgp/)
 * http://github.com/Mottie/epgp
 *
 * Author: Rob G, aka Mottie (mottie.guildportal.com)
 * Dual licensed under the MIT or GPL Version 2 licenses.
 *
 * v1.2 12/13/2010 Updated to work with epgp addon v5.5.22
 * v1.1 9/19/2010 Internalized standings html & added slider options
 * v1.0 8/25/2010 Original version, posted to github
 */

(function(f){f.fn.epgp=function(y,z){var u=f.extend({},f.fn.epgp.defaults,y),v=f.extend({},f.fn.epgp.language,z);return this.each(function(){var j=f(this),e=f.meta?f.extend({},u,j.data()):u,h=f.meta?f.extend({},v,j.data()):v,d,a,n,r,o,b,w=function(g){var m=[],l=[],c=[],i=[],k=g.log,p=g.snapshot.time-(j.find(".slider:first").data("value")||e.startEpgpHistory)*24*60*60;g=g.snapshot.time-(j.find(".slider:last").data("value")||e.startLootHistory)*24*60*60;for(d=0;d<k.length;d++){a=k[d][0];if(a>p||a>g){b= k[d][2];r=k[d][3];if(a>p){if(typeof m[b]==="undefined"){m[b]=0;l[b]=0}m[b]+=k[d][1]=="EP"?k[d][4]:0;l[b]+=k[d][1]=="GP"?k[d][4]:0}if(a>g&&r.match("Hitem")){if(typeof c[b]==="undefined")c[b]='<div class="title">'+h.lootTitle+b+'</div><table class="loot"><tr class="header"><th class="date">'+h.timeTitle+'</th><th class="item">'+h.itemTitle+'</th><th class="gp">GP</th></tr>';r=r.split("|");a=new Date(k[d][0]*1E3);n=a.toDateString().split(" ");i[b]='<a style="color:#'+r[1].slice(-6)+'" href="http://'+ h.wowhead+".wowhead.com/item="+r[2].split(":")[1]+'">'+r[3].replace(/h\[|\]/g,"")+"</a>";c[b]+='<tr><td class="date">'+n[2]+" "+n[1]+" "+a.toLocaleTimeString()+'</td><td class="item">'+i[b]+'</td><td class="gp">'+k[d][4]+"</td></tr>"}}}return[m,l,c,i]},A=function(){if(j.data("data").namespaces.log.profiles.hasOwnProperty(e.guild)){var g=j.data("data").namespaces.log.profiles[e.guild],m=parseInt(e.baseGP,10),l=new Date(g.snapshot.time*1E3),c=l.getHours(),i=c>12?"PM":"AM";c=c>12?c-12:c;a='<div class="header">'+ h.dateTitle+': <span class="date"></span><br><br>'+h.decayTitle+': <span class="decay">'+e.decay+"</span> "+h.baseGPTitle+': <span class="base">'+e.baseGP+"</span> "+h.minEPTitle+': <span class="min">'+e.minEP+"</span> "+h.extrasTitle+': <span class="extras">'+e.extras+'</span></div><br><table class="epgp"><thead><tr class="title"><th class="name class">'+h.nameTitle+'</th><th class="ep">EP</th><th class="gp">GP</th><th class="pr">PR</th><th class="lastitem">'+h.lastItemTitle+"</th></tr></thead><tbody></tbody></table>"; j.html(a);if(e.addSliders){a='<div class="sliders"><div>'+h.epgpSlider.replace(/\{days\}/g,'<span class="count"></span>')+'<br><div class="slider"></div></div><br><div>'+h.lootSlider.replace(/\{days\}/g,'<span class="count"></span>')+'<br><div class="slider"></div></div></div>';j.find(".header").prepend(a)}j.find(".date").html(l.toDateString()+" "+c+":"+l.getMinutes()+" "+i);l=w(g);var k,p=g.snapshot.roster_info;a="";for(d=0;d<p.length;d++){n=p[d][2].split(",");if(n.length>1&&n[0]!="0"){b=p[d];n= b[2].split(",");c=parseInt(n[0],10);i=parseInt(n[1],10)+m;k=i===0?"":(c/i).toFixed(3);if(k===0)k="0";a+='<tr><td class="name '+b[1].toLowerCase()+'"><span class="data">'+b[0]+'</span></td><td class="ep"><span class="data">'+n[0]+'</span> <span class="diff ';c=l[0][b[0]]||"";a+=c===0||c===""?"":c<0?"negative":"positive";a+='">'+c+'</span></td><td class="gp"><span class="data">'+i+'</span> <span class="diff ';i=l[1][b[0]]||"";a+=i===0||i===""?"":i<0?"negative":"positive";a+='">'+i+'</span></td><td class="pr"><span class="data">'+ k+'</span></td><td class="lastitem">';a+=typeof l[2][b[0]]==="undefined"?"":'<img src="'+e.lootIcon+'" class="tooltip" title="'+l[2][b[0]].replace(/\"/g,"&quot;")+'</table>">';a+=typeof l[3][b[0]]==="undefined"?"":'<span class="data">'+l[3][b[0]]+"</span>";a+="</td></tr>"}}if(a==="")j.html('<div align="center">'+h.noData+"</div>");else{j.find("tbody").append(a);j.find("table").tablesorter({textExtraction:function(q){return f(q).find("span.data").text()},sortList:[e.sort]});if(e.addSliders){j.find(".slider").slider({min:1, max:e.maxHistory,step:1,slide:function(q,x){f(this).data("value",x.value);f(this).parent().find(".count").html(x.value);var s,t=w(g);j.find("tbody tr").each(function(){b=f(this).find(".name span").html();o=Math.round(t[0][b])||"";s=o===0||o===""?"":o<0?"negative":"positive";f(this).find(".ep .diff").removeClass("negative positive").addClass(s).html(o);o=Math.round(t[1][b])||"";s=o===0||o===""?"":o<0?"negative":"positive";f(this).find(".gp .diff").removeClass("negative positive").addClass(s).html(o); f(this).find(".lastitem img").attr("title",t[2][b])})}});j.find(".sliders").find(".slider:first").slider("option","value",e.startEpgpHistory).data("value",e.startEpgpHistory).end().find(".count:first").html(e.startEpgpHistory).end().find(".slider:last").slider("option","value",e.startLootHistory).data("value",e.startLootHistory).end().find(".count:last").html(e.startLootHistory)}}}else j.html(h.noGuild)};f.ajax({url:e.epgpfile,success:function(g){g=g.replace(/\[(.*)\]\s\=\s/g,"$1:").replace(/[\t\r\n]/g, "").replace(/\}\,\s--\s\[\d+\]\}/g,"]]").replace(/\,\s--\s\[\d+\]/g,",").replace(/,(\}|\])/g,"$1").replace(/\}\,\{/g,"],[").replace(/\{\{/g,"[[").replace(/EPGP_DB\s\=/,"");g=f.parseJSON(g);j.data("data",g);if(e.lootOnly){var m,l;g=[];m=j.data("data").namespaces.log.profiles[e.guild];var c=m.snapshot.roster_info,i=m.log,k=i.length-1,p=m.snapshot.time-(e.startLootHistory-1)*24*60*60-e.raidTime*60*60,q='<table class="loot"><tr class="header"><th class="date">'+h.timeTitle+'</th><th class="member">'+ h.memberTitle+'</th><th class="item">'+h.itemTitle+'</th><th class="gp">GP</th></tr>';a="";for(d=0;d<c.length;d++)g[c[d][0]]=c[d][1].toLowerCase();f.extend(g,e.fixClass);for(m=0;m<k;m++){d=k-m;a=i[d][0];c=i[d][3];if(a>p&&c.match("Hitem")){b=i[d][2];c=c.split("|");a=new Date(i[d][0]*1E3);n=a.toDateString().split(" ");l=typeof g[b]==="undefined"?"unknown":g[b];q+='<tr><td class="date">'+n[2]+" "+n[1]+" "+a.toLocaleTimeString().replace(/:00\s/g," ")+'</td><td class="member '+l.toLowerCase()+'">'+b+'</td><td class="item"><a style="color:#'+ c[1].slice(-6)+'" href="http://'+h.wowhead+".wowhead.com/item="+c[2].split(":")[1]+'">'+c[3].replace(/h\[|\]/g,"")+'</a></td><td class="gp">'+i[d][4]+"</td></tr>"}if(a<p)break}q=q.length<150?'<div align="center">'+h.noData+"</div>":q+"</table>";j.html(q)}else A()},error:function(){j.html('<div align="center">'+h.noData+"</div>")}})})};f.fn.epgp.defaults={epgpfile:"epgp.lua",guild:"Fallout",startEpgpHistory:7,startLootHistory:7,addSliders:true,maxHistory:30,baseGP:"1000",minEP:"1000",decay:"15",extras:"100%", lootIcon:"images/plus.gif",sort:[3,1],lootOnly:false,raidTime:4,fixClass:[]};f.fn.epgp.language={wowhead:"www",lootTitle:"Loot History for ",nameTitle:"Name",timeTitle:"Time",dateTitle:"Date",memberTitle:"Member",itemTitle:"Item",lastItemTitle:"Last Item",baseGPTitle:"BaseGP",minEPTitle:"MinEP",decayTitle:"Decay",extrasTitle:"Extras",epgpSlider:"EPGP ({days} days from snapshot)",lootSlider:"Loot ({days} days from snapshot)",noData:"No Data Found!",noGuild:"Guild Not Found!"}})(jQuery);
